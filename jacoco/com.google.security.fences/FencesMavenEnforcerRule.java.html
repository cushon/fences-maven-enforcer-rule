<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FencesMavenEnforcerRule.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Fences Enforcer Rule</a> &gt; <a href="index.source.html" class="el_package">com.google.security.fences</a> &gt; <span class="el_source">FencesMavenEnforcerRule.java</span></div><h1>FencesMavenEnforcerRule.java</h1><pre class="source lang-java linenums">package com.google.security.fences;

import org.apache.maven.artifact.Artifact;
import org.apache.maven.artifact.repository.ArtifactRepository;
import org.apache.maven.artifact.resolver.ArtifactNotFoundException;
import org.apache.maven.artifact.resolver.ArtifactResolutionException;
import org.apache.maven.artifact.resolver.ArtifactResolver;
import org.apache.maven.enforcer.rule.api.EnforcerRule;
import org.apache.maven.enforcer.rule.api.EnforcerRuleException;
import org.apache.maven.enforcer.rule.api.EnforcerRuleHelper;
import org.apache.maven.plugin.logging.Log;
import org.apache.maven.project.MavenProject;
import org.apache.maven.shared.dependency.tree.DependencyTreeBuilder;
import org.apache.maven.shared.dependency.tree.DependencyTreeBuilderException;
import org.codehaus.plexus.component.configurator.BasicComponentConfigurator;
import org.codehaus.plexus.component.configurator.ComponentConfigurator;
import org.codehaus.plexus.component.configurator.expression.ExpressionEvaluationException;
import org.codehaus.plexus.component.repository.exception.ComponentLookupException;
import org.codehaus.plexus.interpolation.PropertiesBasedValueSource;
import org.w3c.dom.Element;

import com.google.common.collect.ImmutableList;
import com.google.common.collect.Lists;
import com.google.common.collect.Sets;
import com.google.security.fences.config.ApiFence;
import com.google.security.fences.config.ClassFence;
import com.google.security.fences.config.Fence;
import com.google.security.fences.config.PackageFence;
import com.google.security.fences.inheritance.InheritanceGraph;
import com.google.security.fences.policy.ApiElement;
import com.google.security.fences.policy.Policy;
import com.google.security.fences.util.LazyString;
import com.google.security.fences.util.Utils;

import java.io.IOException;
import java.io.StringWriter;
import java.util.LinkedList;
import java.util.List;
import java.util.Set;

import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

/**
 * Augments Java access control by verifying that a project and its dependencies
 * don't statically violate a policy.
 */
<span class="nc" id="L53">public final class FencesMavenEnforcerRule implements EnforcerRule {</span>

<span class="nc" id="L55">  private final List&lt;Fence&gt; fences = Lists.newArrayList();</span>
<span class="nc" id="L56">  private final LinkedList&lt;ConfigurationImport&gt; imports = Lists.newLinkedList();</span>
<span class="nc" id="L57">  private final Set&lt;ConfigurationImport.PartialArtifactKey&gt; alreadyImported =</span>
<span class="nc" id="L58">      Sets.newLinkedHashSet();</span>

  private void addFence(Fence f) throws EnforcerRuleException {
<span class="nc" id="L61">    f.check();</span>
<span class="nc" id="L62">    fences.add(f);</span>
<span class="nc" id="L63">  }</span>

  /**
   * A setter called by reflection during configuration.  Actually adds
   * instead of blowing away prior value.
   */
  public void setApi(ApiFence x) throws EnforcerRuleException {
<span class="nc" id="L70">    addFence(x);</span>
<span class="nc" id="L71">  }</span>

  /**
   * A setter called by reflection during configuration.  Actually adds
   * instead of blowing away prior value.
   */
  public void setPackage(PackageFence x) throws EnforcerRuleException {
<span class="nc" id="L78">    addFence(x);</span>
<span class="nc" id="L79">  }</span>

  /**
   * A setter called by reflection during configuration.  Actually adds
   * instead of blowing away prior value.
   */
  public void setClass(ClassFence x) throws EnforcerRuleException {
<span class="nc" id="L86">    addFence(x);</span>
<span class="nc" id="L87">  }</span>

  /**
   * A setter called by reflection during configuration.  Actually adds
   * instead of blowing away prior value.
   */
  public void setImport(String x) throws EnforcerRuleException {
<span class="nc" id="L94">    imports.add(new ConfigurationImport(x));</span>
<span class="nc" id="L95">  }</span>

  /**
   * A setter called by reflection during configuration.  Actually adds
   * an {@code &lt;api&gt;} with an {@code &lt;addendum&gt;} instead of blowing away prior
   * value.
   */
  public void setAddendum(String x) throws EnforcerRuleException {
<span class="nc" id="L103">    Fence api = new ApiFence();</span>
<span class="nc" id="L104">    api.setAddendum(x);</span>
<span class="nc" id="L105">    fences.add(api);</span>
<span class="nc" id="L106">  }</span>

  public void execute(EnforcerRuleHelper helper) throws EnforcerRuleException {
<span class="nc" id="L109">    final Log log = helper.getLog();</span>

    // TODO: maybe check MavenSession.getGoals() to see if this is being
    // run at phase &quot;validate&quot; instead of phase &quot;verify&quot; to warn of a
    // missing &lt;phase&gt;verify&lt;/phase&gt; in the enforcer plugin configuration.

    ArtifactResolver resolver;
    DependencyTreeBuilder treeBuilder;
    ComponentConfigurator configurator;
    try {
<span class="nc" id="L119">      resolver = (ArtifactResolver) helper.getComponent(ArtifactResolver.class);</span>
<span class="nc" id="L120">      treeBuilder = (DependencyTreeBuilder)</span>
<span class="nc" id="L121">          helper.getComponent(DependencyTreeBuilder.class);</span>

      // This seems &quot;the right way&quot; since plexus is supposed to inject
      // dependencies, but when run without -X to turn on debugging,
      // we get a MapOrientedComponentConfigurator which cannot configure
      // this object.
      // http://stackoverflow.com/questions/35919157/using-xmlplexusconfiguration-to-import-more-configuration-for-a-bean-style-maven
      // explains the symptoms.
      //  configurator = (ComponentConfigurator) helper.getComponent(
      //      ComponentConfigurator.class);
<span class="nc" id="L131">      configurator = new BasicComponentConfigurator();</span>
<span class="nc" id="L132">    } catch (ComponentLookupException ex) {</span>
<span class="nc" id="L133">      throw new EnforcerRuleException(</span>
<span class="nc" id="L134">          &quot;Failed to locate component: &quot; + ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L135">    }</span>

    MavenProject project;
    ArtifactRepository localRepository;
    List&lt;ArtifactRepository&gt; remoteRepositories;
    try {
<span class="nc" id="L141">      project = (MavenProject) helper.evaluate(&quot;${project}&quot;);</span>
<span class="nc" id="L142">      localRepository = (ArtifactRepository)</span>
<span class="nc" id="L143">          helper.evaluate(&quot;${localRepository}&quot;);</span>
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L145">      List&lt;ArtifactRepository&gt; rr = (List&lt;ArtifactRepository&gt;)</span>
<span class="nc" id="L146">          helper.evaluate(&quot;${project.remoteArtifactRepositories}&quot;);</span>
<span class="nc" id="L147">      remoteRepositories = rr;</span>
<span class="nc" id="L148">    } catch (ExpressionEvaluationException ex) {</span>
<span class="nc" id="L149">      throw new EnforcerRuleException(</span>
<span class="nc" id="L150">          &quot;Failed to locate component: &quot; + ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L151">    }</span>

<span class="nc" id="L153">    ArtifactFinder finder = new ArtifactFinder(</span>
        resolver, treeBuilder, localRepository, remoteRepositories, log);

    try {
<span class="nc" id="L157">      finder.findClassRoots(project);</span>
<span class="nc" id="L158">    } catch (DependencyTreeBuilderException ex) {</span>
<span class="nc" id="L159">      throw new EnforcerRuleException(&quot;Failed to find artifacts&quot;, ex);</span>
<span class="nc" id="L160">    } catch (ArtifactResolutionException ex) {</span>
<span class="nc" id="L161">      throw new EnforcerRuleException(&quot;Failed to find artifacts&quot;, ex);</span>
<span class="nc" id="L162">    } catch (ArtifactNotFoundException ex) {</span>
<span class="nc" id="L163">      throw new EnforcerRuleException(&quot;Failed to find artifacts&quot;, ex);</span>
<span class="nc" id="L164">    }</span>

<span class="nc" id="L166">    ImmutableList&lt;ClassRoot&gt; classRoots = finder.getClassRoots();</span>

    InheritanceGraph inheritanceGraph;
    try {
<span class="nc" id="L170">      inheritanceGraph = InheritanceGraphExtractor</span>
<span class="nc" id="L171">          .fromClassRoots(classRoots);</span>
<span class="nc" id="L172">    } catch (IOException ex) {</span>
<span class="nc" id="L173">      throw new EnforcerRuleException(</span>
          &quot;Failed to read classes to find inheritance relationships&quot;,
          ex);
<span class="nc" id="L176">    }</span>

<span class="nc" id="L178">    int nAssignedImportOrder = 0;</span>
<span class="nc" id="L179">    int importOrder = 0;</span>
    // Do the imports.
    // Since an import might load a configuration that adds more imports, we
    // just walk the list destructively.
<span class="nc bnc" id="L183" title="All 2 branches missed.">    for (; !imports.isEmpty(); ++importOrder) {</span>
<span class="nc" id="L184">      nAssignedImportOrder = rerootAndAssignImportOrder(</span>
          inheritanceGraph, nAssignedImportOrder, importOrder);
<span class="nc" id="L186">      ConfigurationImport imp = imports.removeFirst();</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">      if (alreadyImported.add(imp.key)) {</span>
<span class="nc" id="L188">        log.debug(&quot;Importing &quot; + imp.key);</span>
<span class="nc" id="L189">        imp.configure(</span>
            this, configurator,
<span class="nc" id="L191">            new ConfigurationImport.ClassRoots(classRoots.iterator()),</span>
            log);
      } else {
<span class="nc" id="L194">        log.info(&quot;Not importing &quot; + imp.key + &quot; a second time&quot;);</span>
      }
    }
<span class="nc" id="L197">    rerootAndAssignImportOrder(</span>
        inheritanceGraph, nAssignedImportOrder, importOrder);

<span class="nc" id="L200">    ImmutableList&lt;Fence&gt; allFences = ImmutableList.copyOf(fences);</span>

<span class="nc bnc" id="L202" title="All 2 branches missed.">    if (allFences.isEmpty()) {</span>
<span class="nc" id="L203">      throw new EnforcerRuleException(</span>
          &quot;No fences.  Please configure this rule with a policy.&quot;
          + &quot;  See https://github.com/mikesamuel/&quot;
          + &quot;fences-maven-enforcer-rule/blob/master/src/site/markdown/usage.md&quot;
          + &quot; for details&quot;);
    }

    // Merge all the fences into one master.
<span class="nc" id="L211">    final ApiFence mergedFence = new ApiFence();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">    for (Fence f : allFences) {</span>
<span class="nc" id="L213">      mergedFence.mergeDeep(f);</span>
<span class="nc" id="L214">    }</span>

    // Log the effective configuration
<span class="nc" id="L217">    boolean showConfig = RelevantSystemProperties.shouldShowEffectiveConfig();</span>
<span class="nc bnc" id="L218" title="All 4 branches missed.">    if (showConfig || log.isDebugEnabled()) {</span>
      try {
<span class="nc" id="L220">        Element config = mergedFence.buildEffectiveConfiguration();</span>
<span class="nc" id="L221">        TransformerFactory tf = TransformerFactory.newInstance();</span>
<span class="nc" id="L222">        Transformer transformer = tf.newTransformer();</span>
<span class="nc" id="L223">        transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, &quot;yes&quot;);</span>
<span class="nc" id="L224">        transformer.setOutputProperty(OutputKeys.METHOD, &quot;xml&quot;);</span>
<span class="nc" id="L225">        transformer.setOutputProperty(OutputKeys.INDENT, &quot;yes&quot;);</span>
<span class="nc" id="L226">        transformer.setOutputProperty(OutputKeys.ENCODING, &quot;UTF-8&quot;);</span>
<span class="nc" id="L227">        transformer.setOutputProperty(</span>
            &quot;{http://xml.apache.org/xslt}indent-amount&quot;, &quot;2&quot;);

<span class="nc" id="L230">        StringWriter xmlOut = new StringWriter();</span>
<span class="nc" id="L231">        xmlOut.write(&quot;Effective Fences Rule Configuration:\n&quot;);</span>
<span class="nc" id="L232">        transformer.transform(</span>
            new DOMSource(config),
            new StreamResult(xmlOut));
<span class="nc" id="L235">        String xml = xmlOut.toString();</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (showConfig) {</span>
<span class="nc" id="L237">          log.info(xml);</span>
        } else {
<span class="nc" id="L239">          log.debug(xml);</span>
        }
<span class="nc" id="L241">      } catch (ParserConfigurationException ex) {</span>
<span class="nc" id="L242">        log.error(ex);</span>
<span class="nc" id="L243">      } catch (TransformerException ex) {</span>
<span class="nc" id="L244">        log.error(ex);</span>
<span class="nc" id="L245">      }</span>
    }

<span class="nc" id="L248">    checkAllClasses(project, log, inheritanceGraph, mergedFence, classRoots);</span>
<span class="nc" id="L249">  }</span>

  private int rerootAndAssignImportOrder(
      InheritanceGraph inheritanceGraph, int start, int importOrder)
  throws EnforcerRuleException {
<span class="nc" id="L254">    int end = fences.size();</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">    for (int i = start; i &lt; end; ++i) {</span>
<span class="nc" id="L256">      Fence f = fences.get(i);</span>
<span class="nc" id="L257">      f = f.splitDottedNames(ApiElement.DEFAULT_PACKAGE, inheritanceGraph)</span>
<span class="nc" id="L258">          .promoteToApi();</span>
<span class="nc" id="L259">      f.assignImportOrder(importOrder);</span>
<span class="nc" id="L260">      fences.set(i, f);</span>
    }
<span class="nc" id="L262">    return end;</span>
  }

  protected static void checkAllClasses(
      MavenProject project, Log log, InheritanceGraph inheritanceGraph,
      ApiFence mergedFence, Iterable&lt;? extends ClassRoot&gt; classRoots)
  throws EnforcerRuleException {
<span class="nc" id="L269">    final Policy p = Policy.fromFence(mergedFence);</span>
<span class="nc" id="L270">    log.debug(new LazyString() {</span>
      @Override
      protected String makeString() {
<span class="nc" id="L273">        return &quot;Using policy\n&quot; + p.toString();</span>
      }
    });

<span class="nc" id="L277">    Checker checker = new Checker(log, inheritanceGraph, p);</span>

<span class="nc bnc" id="L279" title="All 2 branches missed.">    for (ClassRoot classRoot : classRoots) {</span>
<span class="nc" id="L280">      Artifact art = classRoot.art;</span>
<span class="nc" id="L281">      log.info(&quot;Checking &quot; + art.getId() + &quot; from scope &quot; + art.getScope());</span>
      try {
<span class="nc" id="L283">        checker.visitAll(ImmutableList.of(classRoot));</span>
<span class="nc" id="L284">      } catch (IOException ex) {</span>
<span class="nc" id="L285">        throw new EnforcerRuleException(</span>
<span class="nc" id="L286">            &quot;Failed to check &quot; + Utils.artToString(art), ex);</span>
<span class="nc" id="L287">      }</span>
<span class="nc" id="L288">    }</span>

<span class="nc" id="L290">    ImmutableList&lt;Violation&gt; violations = checker.getViolations();</span>
<span class="nc" id="L291">    PolicyViolationReporter reporter = new PolicyViolationReporter(log);</span>
<span class="nc" id="L292">    reporter.interpolator.addValueSource(</span>
<span class="nc" id="L293">        new PropertiesBasedValueSource(project.getProperties()));</span>
<span class="nc" id="L294">    int errorCount = reporter.report(violations);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">    if (errorCount != 0) {</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">      String message = errorCount + &quot; access policy violation&quot;</span>
          + (errorCount == 1 ? &quot;&quot; : &quot;s&quot;);
<span class="nc bnc" id="L298" title="All 2 branches missed.">      if (RelevantSystemProperties.inExperimentalMode()) {</span>
<span class="nc" id="L299">        log.info(message + &quot; ignored in experimental mode&quot;);</span>
      } else {
<span class="nc" id="L301">        throw new EnforcerRuleException(message);</span>
      }
    }
<span class="nc" id="L304">  }</span>

  public String getCacheId() {
<span class="nc" id="L307">    return null;</span>
  }

  public boolean isCacheable() {
<span class="nc" id="L311">    return false;</span>
  }

  public boolean isResultValid(EnforcerRule arg0) {
<span class="nc" id="L315">    return false;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>