<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PolicyViolationReporter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Fences Enforcer Rule</a> &gt; <a href="index.source.html" class="el_package">com.google.security.fences</a> &gt; <span class="el_source">PolicyViolationReporter.java</span></div><h1>PolicyViolationReporter.java</h1><pre class="source lang-java linenums">package com.google.security.fences;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.apache.maven.plugin.logging.Log;

import org.codehaus.plexus.interpolation.InterpolationException;
import org.codehaus.plexus.interpolation.Interpolator;
import org.codehaus.plexus.interpolation.MapBasedValueSource;
import org.codehaus.plexus.interpolation.ObjectBasedValueSource;
import org.codehaus.plexus.interpolation.RegexBasedInterpolator;
import org.codehaus.plexus.interpolation.ValueSource;

import com.google.common.base.Function;
import com.google.common.base.Joiner;
import com.google.common.base.Optional;
import com.google.common.base.Preconditions;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.google.common.collect.Sets;
import com.google.security.fences.config.HumanReadableText;

/**
 * Groups a collection of violations so that we can provide succinct, clear
 * error messages.
 */
final class PolicyViolationReporter {
  final Log log;
  final Interpolator interpolator;

<span class="nc" id="L37">  PolicyViolationReporter(Log log) {</span>
<span class="nc" id="L38">    this.log = log;</span>
<span class="nc" id="L39">    this.interpolator = new RegexBasedInterpolator();</span>
<span class="nc" id="L40">  }</span>

  /**
   * Reports the violations to the log.
   *
   * @return non-zero iff there was a violation.
   */
  int report(ImmutableList&lt;Violation&gt; violations) {
<span class="nc" id="L48">    int errorCount = violations.size();</span>
    // Probably overly paranoid given ints are always 32b.
<span class="nc bnc" id="L50" title="All 6 branches missed.">    if (!(violations.isEmpty() ? errorCount == 0 : errorCount &gt; 0)) {</span>
      // Causing the error counter to overflow should not spuriously report
      // compliance.
<span class="nc" id="L53">      errorCount = Integer.MAX_VALUE;</span>
    }
<span class="nc bnc" id="L55" title="All 2 branches missed.">    if (errorCount == 0) {</span>
<span class="nc" id="L56">      log.info(&quot;No access policy violations&quot;);</span>
<span class="nc" id="L57">      return 0;</span>
    }

<span class="nc" id="L60">    List&lt;Violation&gt; violationsInOrder = new ArrayList&lt;Violation&gt;(violations);</span>
    // Sorting lets us group things into a nice, neat form.
<span class="nc" id="L62">    Collections.sort(violationsInOrder);</span>
<span class="nc" id="L63">    ImmutableList&lt;Violation&gt; violationList = ImmutableList.copyOf(</span>
        violationsInOrder);

<span class="nc" id="L66">    ReportTree t = groupByArtifactAndReport(violationList);</span>
<span class="nc" id="L67">    String logMessage = t.toLogMessage();</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">    if (RelevantSystemProperties.inExperimentalMode()) {</span>
<span class="nc" id="L69">      log.warn(logMessage);</span>
    } else {
<span class="nc" id="L71">      log.error(logMessage);</span>
    }

<span class="nc bnc" id="L74" title="All 2 branches missed.">    Preconditions.checkState(errorCount &gt; 0);</span>
<span class="nc" id="L75">    return errorCount;</span>
  }

  /**
   * Expands plexus interpolator expressions in {@code &lt;rationale&gt;} messages.
   */
  private Optional&lt;String&gt; formatRationale(Violation v) {
<span class="nc" id="L82">    HumanReadableText wholeRationale = v.rationale.getWholeText();</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">    if (wholeRationale.isEmpty()) {</span>
<span class="nc" id="L84">      return Optional.absent();</span>
    }
<span class="nc" id="L86">    ValueSource artifactValueSource = new ObjectBasedValueSource(v.artifact);</span>
<span class="nc" id="L87">    ValueSource failedAccessValueSource = new MapBasedValueSource(</span>
<span class="nc" id="L88">        ImmutableMap.of(</span>
<span class="nc" id="L89">            &quot;fences.api&quot;, v.useSiteApiElement.toDottedName(),</span>
            &quot;fences.distrusted&quot;, v.useSiteContainer));
<span class="nc" id="L91">    interpolator.addValueSource(artifactValueSource);</span>
<span class="nc" id="L92">    interpolator.addValueSource(failedAccessValueSource);</span>
<span class="nc" id="L93">    String rationaleText = wholeRationale.text;</span>
    try {
<span class="nc" id="L95">      rationaleText = interpolator.interpolate(rationaleText);</span>
<span class="nc" id="L96">    } catch (InterpolationException ex) {</span>
<span class="nc" id="L97">      log.warn(ex);</span>
    } finally {
<span class="nc" id="L99">      interpolator.removeValuesSource(failedAccessValueSource);</span>
<span class="nc" id="L100">      interpolator.removeValuesSource(artifactValueSource);</span>
<span class="nc" id="L101">    }</span>
<span class="nc" id="L102">    return Optional.of(rationaleText);</span>
  }

  private static ImmutableList&lt;ReportTree&gt; group(
      Function&lt;Violation, String&gt; getGroup,
      Function&lt;ImmutableList&lt;Violation&gt;, ImmutableList&lt;ReportTree&gt;&gt; descend,
      ImmutableList&lt;Violation&gt; violations) {
<span class="nc" id="L109">    int n = violations.size();</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">    if (n == 0) {</span>
<span class="nc" id="L111">      return ImmutableList.of();</span>
    }
<span class="nc" id="L113">    ImmutableList.Builder&lt;ReportTree&gt; groups = ImmutableList.builder();</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">    for (int i = 0, groupEnd; i &lt; n; i = groupEnd) {</span>
<span class="nc" id="L115">      String group = getGroup.apply(violations.get(i));</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">      for (groupEnd = i + 1; groupEnd &lt; n; ++groupEnd) {</span>
<span class="nc" id="L117">        String g = getGroup.apply(violations.get(groupEnd));</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (!group.equals(g)) {</span>
<span class="nc" id="L119">          break;</span>
        }
      }
<span class="nc" id="L122">      ReportTree t = new ReportTree(group);</span>
<span class="nc" id="L123">      t.children.addAll(descend.apply(violations.subList(i, groupEnd)));</span>
<span class="nc" id="L124">      groups.add(t);</span>
    }
<span class="nc" id="L126">    return groups.build();</span>
  }

  private ReportTree groupByArtifactAndReport(
      ImmutableList&lt;Violation&gt; violations) {
<span class="nc" id="L131">    ReportTree root = new ReportTree(&quot;&quot;);</span>
<span class="nc" id="L132">    root.children.addAll(group(</span>
<span class="nc" id="L133">        new Function&lt;Violation, String&gt;() {</span>
          public String apply(Violation v) {
<span class="nc" id="L135">            return v.artifact.getId();</span>
          }
        },
<span class="nc" id="L138">        new Function&lt;ImmutableList&lt;Violation&gt;, ImmutableList&lt;ReportTree&gt;&gt;() {</span>
          @SuppressWarnings(&quot;synthetic-access&quot;)
          public ImmutableList&lt;ReportTree&gt; apply(
              ImmutableList&lt;Violation&gt; vs) {
<span class="nc" id="L142">            return groupByUseSiteSource(vs);</span>
          }
        },
        violations));
<span class="nc" id="L146">    return root;</span>
  }

  private ImmutableList&lt;ReportTree&gt; groupByUseSiteSource(
      ImmutableList&lt;Violation&gt; violations) {
<span class="nc" id="L151">    return group(</span>
<span class="nc" id="L152">        new Function&lt;Violation, String&gt;() {</span>
          public String apply(Violation v) {
<span class="nc" id="L154">            return v.useSiteSource;</span>
          }
        },
<span class="nc" id="L157">        new Function&lt;ImmutableList&lt;Violation&gt;, ImmutableList&lt;ReportTree&gt;&gt;() {</span>
          @SuppressWarnings(&quot;synthetic-access&quot;)
          public ImmutableList&lt;ReportTree&gt; apply(ImmutableList&lt;Violation&gt; vs) {
<span class="nc" id="L160">            return groupByUseSiteLine(vs);</span>
          }
        },
        violations);
  }

  private ImmutableList&lt;ReportTree&gt; groupByUseSiteLine(
      ImmutableList&lt;Violation&gt; violations) {
<span class="nc" id="L168">    return group(</span>
<span class="nc" id="L169">        new Function&lt;Violation, String&gt;() {</span>
          public String apply(Violation v) {
<span class="nc bnc" id="L171" title="All 2 branches missed.">            return v.useSiteLineNumber &lt; 0 ? &quot;&quot; : &quot;L&quot; + v.useSiteLineNumber;</span>
          }
        },
<span class="nc" id="L174">        new Function&lt;ImmutableList&lt;Violation&gt;, ImmutableList&lt;ReportTree&gt;&gt;() {</span>
          @SuppressWarnings(&quot;synthetic-access&quot;)
          public ImmutableList&lt;ReportTree&gt; apply(ImmutableList&lt;Violation&gt; vs) {
<span class="nc" id="L177">            return formatViolations(vs);</span>
          }
        },
        violations);
  }

  private ImmutableList&lt;ReportTree&gt; formatViolations(
      ImmutableList&lt;Violation&gt; violations) {
<span class="nc" id="L185">    Map&lt;String, Integer&gt; errorMessages = Maps.newLinkedHashMap();</span>
<span class="nc" id="L186">    Set&lt;String&gt; rationales = Sets.newLinkedHashSet();</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">    for (Violation v : violations) {</span>
<span class="nc" id="L188">      String message =</span>
<span class="nc" id="L189">          v.useSiteApiElement.toDottedName() + &quot; cannot be accessed from &quot;</span>
          + v.useSiteContainer;
<span class="nc bnc" id="L191" title="All 2 branches missed.">      if (!v.sensitiveApiElement.equals(v.useSiteApiElement)) {</span>
<span class="nc" id="L192">        message += &quot; because &quot; + v.sensitiveApiElement.toDottedName()</span>
            + &quot; is restricted&quot;;
      }
<span class="nc" id="L195">      Optional&lt;String&gt; rationale = formatRationale(v);</span>
<span class="nc" id="L196">      Integer priorCount = errorMessages.get(message);</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">      errorMessages.put(message, 1 + (priorCount != null ? priorCount : 0));</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">      if (rationale.isPresent()) {</span>
<span class="nc" id="L199">        rationales.add(rationale.get());</span>
      }
<span class="nc" id="L201">    }</span>
<span class="nc" id="L202">    ImmutableList.Builder&lt;ReportTree&gt; leaves = ImmutableList.builder();</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">    for (Map.Entry&lt;String, Integer&gt; e : errorMessages.entrySet()) {</span>
<span class="nc" id="L204">      String message = e.getKey();</span>
<span class="nc" id="L205">      int count = e.getValue();</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">      if (count != 1) {</span>
<span class="nc" id="L207">        message += &quot; (&quot; + count + &quot; times)&quot;;</span>
      }
<span class="nc" id="L209">      leaves.add(new ReportTree(message));</span>
<span class="nc" id="L210">    }</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">    for (String rationale : rationales) {</span>
<span class="nc" id="L212">      leaves.add(new ReportTree(rationale));</span>
<span class="nc" id="L213">    }</span>
<span class="nc" id="L214">    return leaves.build();</span>
  }

  /**
   * A tree used to avoid having large numbers of similar policy violations
   * using a lot of boilerplate like
   *
   * &lt;pre&gt;
   * group:artifact:version : OneSourceFile.java : L32 : blah blah
   * group:artifact:version : OneSourceFile.java : L32 : more blah
   * group:artifact:version : AnotherSourceFile.java : L32 : blah blah
   * group:artifact:version : AnotherSourceFile.java : L33 : blah blah
   * group:artifact:version : AnotherSourceFile.java : L33 : more blah
   * &lt;/pre&gt;
   *
   * but instead produces
   *
   * &lt;pre&gt;
   * group:artifact:version
   * . OneSourceFile.java : L32
   * . . blah blah
   * . . more blah
   * . AnotherSourceFile.java
   * . . L32 : blah blah
   * . . L33
   * . . . blah blah
   * . . . more blah
   * &lt;/pre&gt;
   */
  static final class ReportTree {
    final List&lt;ReportTree&gt; children;
    final String text;

    ReportTree(String text) {
<span class="nc" id="L248">      this(text, Lists.&lt;ReportTree&gt;newArrayList());</span>
<span class="nc" id="L249">    }</span>

<span class="nc" id="L251">    ReportTree(String text, List&lt;ReportTree&gt; children) {</span>
<span class="nc" id="L252">      this.text = text;</span>
<span class="nc" id="L253">      this.children = children;</span>
<span class="nc" id="L254">    }</span>

    String toLogMessage() {
<span class="nc" id="L257">      StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L258">      appendLogMessage(0, sb);</span>
<span class="nc" id="L259">      return sb.toString();</span>
    }

    private void appendLogMessage(int depth, StringBuilder sb) {
      // Don't nest unless there are multiple children.
<span class="nc bnc" id="L264" title="All 2 branches missed.">      if (children.size() == 1) {</span>
<span class="nc" id="L265">        ReportTree soleChild = children.get(0);</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (!&quot;&quot;.equals(text)) {</span>
<span class="nc" id="L267">          String combinedText = text;</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">          if (!&quot;&quot;.equals(soleChild.text)) {</span>
<span class="nc" id="L269">            combinedText += &quot; : &quot; + soleChild.text;</span>
<span class="nc" id="L270">            soleChild = new ReportTree(combinedText, soleChild.children);</span>
          }
        }
<span class="nc" id="L273">        soleChild.appendLogMessage(depth, sb);</span>
<span class="nc" id="L274">        return;</span>
      }

<span class="nc" id="L277">      int childDepth = depth;</span>
<span class="nc" id="L278">      boolean newLineBeforeChild = false;</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">      if (!&quot;&quot;.equals(text)) {</span>
<span class="nc" id="L280">        newLineBeforeChild = true;</span>
<span class="nc" id="L281">        ++childDepth;</span>

<span class="nc" id="L283">        int prefixStart = sb.length();</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">        for (int i = 0; i &lt; depth; ++i) {</span>
<span class="nc" id="L285">          sb.append(&quot;. &quot;);</span>
        }
<span class="nc" id="L287">        String indentedText = text;</span>
<span class="nc" id="L288">        String[] lines = text.split(&quot;\r\n?|\n&quot;);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (lines.length != 1) {</span>
<span class="nc" id="L290">          String prefix = sb.substring(prefixStart);</span>
<span class="nc" id="L291">          indentedText = Joiner.on(&quot;\n&quot; + prefix).join(lines);</span>
        }
<span class="nc" id="L293">        sb.append(indentedText);</span>
      }
<span class="nc bnc" id="L295" title="All 2 branches missed.">      for (ReportTree child : children) {</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (newLineBeforeChild) {</span>
<span class="nc" id="L297">          sb.append('\n');</span>
        } else {
<span class="nc" id="L299">          newLineBeforeChild = true;</span>
        }
<span class="nc" id="L301">        child.appendLogMessage(childDepth, sb);</span>
<span class="nc" id="L302">      }</span>
<span class="nc" id="L303">    }</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>